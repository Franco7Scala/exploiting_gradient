import numpy


class SelectorDataset:

    def __init__(self, input_size, classed):
        self.xs = []
        self.ys = []
        self.input_size = input_size
        self.classed = classed

    def add_sample(self, x, y):
        self.xs.append(x)
        self.ys.append(y)

    def get_train_dataset(self, limit=-1):
        if self.classed:
            classed_ys = []
            q_1 = numpy.quantile(self.ys, 0.25)
            q_2 = numpy.quantile(self.ys, 0.50)
            q_3 = numpy.quantile(self.ys, 0.75)
            for y in self.ys:
                if y > q_3:
                    classed_ys.append([0, 0, 0, 1])

                elif q_2 <= y < q_3:
                    classed_ys.append([0, 0, 1, 0])

                elif q_1 <= y < q_2:
                    classed_ys.append([0, 1, 0, 0])

                else:
                    classed_ys.append([1, 0, 0, 0])

            if limit != -1 and len(self.xs) > limit:
                x_array = numpy.array(self.xs[-limit:0])
                y_array = numpy.array(classed_ys[-limit:0])

            else:
                x_array = numpy.array(self.xs)
                y_array = numpy.array(classed_ys)

            return numpy.reshape(x_array, (x_array.shape[0], self.input_size)), y_array

        else:
            if limit != -1 and len(self.xs) > limit:
                x_array = numpy.array(self.xs[-limit:0])
                y_array = numpy.array(self.ys[-limit:0])

            else:
                x_array = numpy.array(self.xs)
                y_array = numpy.array(self.ys)

            return numpy.reshape(x_array, (x_array.shape[0], self.input_size)), y_array

    def __getitem__(self, index):
        return {"x": self.x[index], "y": self.y[index]}

    def __len__(self):
        return self.xs.shape[0]
